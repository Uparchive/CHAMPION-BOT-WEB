<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Teste de Sistema - Champion Bot</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0f0f23;
            color: #00ff00;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.8);
            padding: 30px;
            border: 2px solid #00ff00;
            border-radius: 10px;
        }
        h1 { color: #ffc107; text-align: center; }
        h2 { color: #00ff00; border-bottom: 1px solid #00ff00; padding-bottom: 10px; }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 12px 24px;
            margin: 10px 5px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }
        button:hover {
            background: #ffc107;
            transform: scale(1.05);
        }
        .success { color: #48bb78; }
        .error { color: #ef4444; }
        .warning { color: #ffc107; }
        .info { color: #60a5fa; }
        .log {
            background: rgba(0, 255, 0, 0.1);
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #00ff00;
            border-radius: 5px;
            white-space: pre-wrap;
            font-size: 12px;
        }
        .action-box {
            background: rgba(255, 193, 7, 0.1);
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #ffc107;
            border-radius: 8px;
        }
        pre {
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ SISTEMA DE DIAGN√ìSTICO E CORRE√á√ÉO</h1>
        <p style="text-align: center; color: #60a5fa;">Champion Bot - Verifica√ß√£o de Autentica√ß√£o e Admin</p>

        <div class="action-box">
            <h2>üîß ETAPA 1: Configura√ß√£o Inicial</h2>
            <button onclick="clearAllData()">üóëÔ∏è LIMPAR TODOS OS DADOS</button>
            <button onclick="setupSystem()">‚öôÔ∏è CONFIGURAR SISTEMA</button>
            <button onclick="checkSystem()">üîç VERIFICAR SISTEMA</button>
        </div>

        <div class="action-box">
            <h2>üë§ ETAPA 2: Configurar Usu√°rio Mestre</h2>
            <button onclick="window.location.href='setup_master.html'">üëë Ir para Setup Master</button>
            <button onclick="createMasterQuick()">‚ö° CRIAR MESTRE R√ÅPIDO</button>
        </div>

        <div class="action-box">
            <h2>üîê ETAPA 3: Testar Login</h2>
            <button onclick="window.location.href='auth.html'">üîë Ir para Login</button>
            <button onclick="testLogin()">üß™ TESTAR LOGIN AUTOM√ÅTICO</button>
        </div>

        <div class="action-box">
            <h2>üë®‚Äçüíº ETAPA 4: Acessar Admin</h2>
            <button onclick="window.location.href='admin.html'">üìä Ir para Admin</button>
            <button onclick="testAdminAccess()">üß™ TESTAR ACESSO ADMIN</button>
        </div>

        <h2>üìã LOG DE ATIVIDADES:</h2>
        <div id="log" class="log">Sistema pronto para diagn√≥stico...</div>
    </div>

    <script src="auth.js"></script>
    <script>
        const logDiv = document.getElementById('log');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            const icon = colors[type] || '‚ÑπÔ∏è';
            
            logDiv.innerHTML += `\n[${timestamp}] ${icon} ${message}`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`${icon} ${message}`);
        }

        function clearAllData() {
            if (!confirm('üö® ATEN√á√ÉO!\n\nIsto vai LIMPAR TODOS OS DADOS incluindo usu√°rios e sess√µes.\n\nTem certeza?')) {
                return;
            }
            
            logDiv.innerHTML = '';
            log('üóëÔ∏è Limpando todos os dados...', 'warning');
            
            localStorage.removeItem('championBotUsers');
            localStorage.removeItem('championBotUsersV3');
            localStorage.removeItem('championBotSession');
            sessionStorage.removeItem('championBotSession');
            
            log('‚úÖ Todos os dados foram removidos!', 'success');
            log('üîÑ Sistema resetado. Configure novamente.', 'info');
        }

        function setupSystem() {
            log('‚öôÔ∏è Configurando sistema base...', 'info');
            
            try {
                // Inicializa banco de dados
                if (window.ChampionBotAuth && window.ChampionBotAuth.initializeUserDatabase) {
                    window.ChampionBotAuth.initializeUserDatabase();
                    log('‚úÖ Banco de dados inicializado via auth.js', 'success');
                } else {
                    log('‚ö†Ô∏è ChampionBotAuth n√£o dispon√≠vel, inicializando manualmente', 'warning');
                    
                    // Inicializa manualmente
                    if (!localStorage.getItem('championBotUsersV3')) {
                        const v3Data = {
                            users: [],
                            meta: {
                                version: 3,
                                totalUsers: 0,
                                lastUpdate: new Date().toISOString(),
                                masterUserConfigured: false
                            }
                        };
                        localStorage.setItem('championBotUsersV3', JSON.stringify(v3Data));
                        log('‚úÖ Sistema V3 criado manualmente', 'success');
                    }
                }
                
                log('‚úÖ Sistema configurado! Agora configure o usu√°rio mestre.', 'success');
                
            } catch (error) {
                log('‚ùå Erro ao configurar sistema: ' + error.message, 'error');
                console.error(error);
            }
        }

        async function createMasterQuick() {
            log('‚ö° Criando usu√°rio mestre r√°pido...', 'info');
            
            try {
                const masterUsername = 'Champion Mestre';
                const masterPassword = 'Champion@2025!';
                const masterEmail = 'master@champion.bot';

                // Gera hash da senha
                const passwordHash = await hashPassword(masterPassword);
                log('üîë Hash de senha gerado', 'success');

                // Sistema Antigo
                const oldUsers = JSON.parse(localStorage.getItem('championBotUsers') || '{}');
                oldUsers[masterUsername] = {
                    username: masterUsername,
                    email: masterEmail,
                    passwordHash: passwordHash,
                    isAdmin: true,
                    active: true,
                    createdAt: new Date().toISOString(),
                    lastLogin: null
                };
                localStorage.setItem('championBotUsers', JSON.stringify(oldUsers));
                log('‚úÖ Usu√°rio criado no sistema antigo', 'success');

                // Sistema V3
                const v3Data = JSON.parse(localStorage.getItem('championBotUsersV3') || '{"users": [], "meta": {}}');
                v3Data.users = v3Data.users.filter(u => u.username !== masterUsername);
                
                const masterUser = {
                    id: 'MASTER_USER_001',
                    username: masterUsername,
                    email: masterEmail,
                    passwordHash: passwordHash,
                    isAdmin: true,
                    active: true,
                    subscriptionType: 'permanent',
                    expiryDate: null,
                    createdAt: new Date().toISOString(),
                    lastLogin: null,
                    lastActivity: new Date().toISOString(),
                    metadata: {
                        role: 'SUPER_ADMIN',
                        permissions: 'ALL',
                        setupDate: new Date().toISOString()
                    }
                };

                v3Data.users.unshift(masterUser);
                v3Data.meta = {
                    version: 3,
                    totalUsers: v3Data.users.length,
                    lastUpdate: new Date().toISOString(),
                    masterUserConfigured: true
                };

                localStorage.setItem('championBotUsersV3', JSON.stringify(v3Data));
                log('‚úÖ Usu√°rio criado no sistema V3', 'success');
                log('', 'info');
                log('üéâ USU√ÅRIO MESTRE CRIADO COM SUCESSO!', 'success');
                log('üë§ Usu√°rio: Champion Mestre', 'info');
                log('üîë Senha: Champion@2025!', 'info');
                log('', 'info');
                log('Agora voc√™ pode fazer login!', 'success');

            } catch (error) {
                log('‚ùå Erro ao criar mestre: ' + error.message, 'error');
                console.error(error);
            }
        }

        async function testLogin() {
            log('üß™ Testando login autom√°tico...', 'info');
            
            try {
                const username = 'Champion Mestre';
                const password = 'Champion@2025!';
                
                log(`üë§ Usu√°rio: ${username}`, 'info');
                
                // Valida credenciais
                const isValid = await window.ChampionBotAuth.validateCredentials(username, password);
                
                if (!isValid) {
                    log('‚ùå Credenciais inv√°lidas!', 'error');
                    log('üí° Execute: CONFIGURAR SISTEMA e depois CRIAR MESTRE R√ÅPIDO', 'warning');
                    return;
                }
                
                log('‚úÖ Credenciais v√°lidas!', 'success');
                
                // Cria sess√£o
                window.ChampionBotAuth.createSession(username, true);
                log('‚úÖ Sess√£o criada!', 'success');
                
                // Verifica sess√£o
                const session = window.ChampionBotAuth.getActiveSession();
                if (session) {
                    log('‚úÖ Sess√£o ativa confirmada!', 'success');
                    log(`üìÖ Login: ${session.loginTime}`, 'info');
                    log(`‚è∞ Expira: ${session.expiresAt}`, 'info');
                } else {
                    log('‚ùå Falha ao criar sess√£o', 'error');
                    return;
                }
                
                log('', 'info');
                log('üéâ LOGIN BEM-SUCEDIDO!', 'success');
                log('Agora voc√™ pode acessar o painel admin!', 'success');
                
            } catch (error) {
                log('‚ùå Erro no teste de login: ' + error.message, 'error');
                console.error(error);
            }
        }

        function testAdminAccess() {
            log('üß™ Testando acesso ao admin...', 'info');
            
            try {
                // Verifica sess√£o
                const session = window.ChampionBotAuth.getActiveSession();
                
                if (!session) {
                    log('‚ùå Nenhuma sess√£o ativa!', 'error');
                    log('üí° Execute: TESTAR LOGIN AUTOM√ÅTICO primeiro', 'warning');
                    return;
                }
                
                log(`‚úÖ Sess√£o encontrada: ${session.username}`, 'success');
                
                // Busca usu√°rio no V3
                const v3Data = JSON.parse(localStorage.getItem('championBotUsersV3') || '{"users": []}');
                const user = v3Data.users.find(u => u.username === session.username);
                
                if (!user) {
                    log('‚ùå Usu√°rio n√£o encontrado no sistema V3!', 'error');
                    log('üí° Execute: CRIAR MESTRE R√ÅPIDO', 'warning');
                    return;
                }
                
                log(`‚úÖ Usu√°rio encontrado: ${user.username}`, 'success');
                log(`üë®‚Äçüíº Admin: ${user.isAdmin}`, user.isAdmin ? 'success' : 'error');
                log(`‚úÖ Ativo: ${user.active}`, user.active ? 'success' : 'error');
                log(`‚ôæÔ∏è Tipo: ${user.subscriptionType}`, 'info');
                
                if (!user.isAdmin) {
                    log('‚ùå Usu√°rio n√£o tem permiss√£o de admin!', 'error');
                    return;
                }
                
                if (!user.active) {
                    log('‚ùå Usu√°rio n√£o est√° ativo!', 'error');
                    return;
                }
                
                log('', 'info');
                log('üéâ ACESSO AUTORIZADO AO PAINEL ADMIN!', 'success');
                log('Redirecionando em 2 segundos...', 'info');
                
                setTimeout(() => {
                    window.location.href = 'admin.html';
                }, 2000);
                
            } catch (error) {
                log('‚ùå Erro no teste de admin: ' + error.message, 'error');
                console.error(error);
            }
        }

        function checkSystem() {
            logDiv.innerHTML = '';
            log('üîç VERIFICANDO SISTEMA...', 'info');
            log('', 'info');
            
            try {
                // 1. Sistema Antigo
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                log('üì¶ SISTEMA ANTIGO (championBotUsers)', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                
                const oldUsers = JSON.parse(localStorage.getItem('championBotUsers') || '{}');
                const oldUserCount = Object.keys(oldUsers).length;
                
                log(`Usu√°rios: ${oldUserCount}`, oldUserCount > 0 ? 'success' : 'warning');
                
                if (oldUserCount > 0) {
                    Object.keys(oldUsers).forEach(username => {
                        const user = oldUsers[username];
                        log(`  ‚Ä¢ ${username} - Admin: ${user.isAdmin}, Ativo: ${user.active}`, 'info');
                    });
                } else {
                    log('‚ö†Ô∏è Nenhum usu√°rio no sistema antigo', 'warning');
                }
                
                log('', 'info');
                
                // 2. Sistema V3
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                log('üì¶ SISTEMA V3 (championBotUsersV3)', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                
                const v3Data = JSON.parse(localStorage.getItem('championBotUsersV3') || '{"users": [], "meta": {}}');
                const v3UserCount = v3Data.users ? v3Data.users.length : 0;
                
                log(`Usu√°rios: ${v3UserCount}`, v3UserCount > 0 ? 'success' : 'warning');
                log(`Vers√£o: ${v3Data.meta?.version || 'N/A'}`, 'info');
                log(`Master Configurado: ${v3Data.meta?.masterUserConfigured || false}`, 'info');
                
                if (v3UserCount > 0) {
                    v3Data.users.forEach(user => {
                        log(`  ‚Ä¢ ${user.username} - Admin: ${user.isAdmin}, Ativo: ${user.active}, Tipo: ${user.subscriptionType}`, 'info');
                    });
                } else {
                    log('‚ö†Ô∏è Nenhum usu√°rio no sistema V3', 'warning');
                }
                
                log('', 'info');
                
                // 3. Sess√£o
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                log('üîê SESS√ÉO ATIVA', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                
                const sessionTemp = sessionStorage.getItem('championBotSession');
                const sessionPerm = localStorage.getItem('championBotSession');
                
                if (sessionTemp) {
                    const session = JSON.parse(sessionTemp);
                    log('‚úÖ Sess√£o tempor√°ria encontrada', 'success');
                    log(`  Usu√°rio: ${session.username}`, 'info');
                    log(`  Login: ${session.loginTime}`, 'info');
                    log(`  Expira: ${session.expiresAt}`, 'info');
                } else if (sessionPerm) {
                    const session = JSON.parse(sessionPerm);
                    log('‚úÖ Sess√£o permanente encontrada', 'success');
                    log(`  Usu√°rio: ${session.username}`, 'info');
                    log(`  Login: ${session.loginTime}`, 'info');
                    log(`  Expira: ${session.expiresAt}`, 'info');
                } else {
                    log('‚ö†Ô∏è Nenhuma sess√£o ativa', 'warning');
                }
                
                log('', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                log('‚úÖ VERIFICA√á√ÉO CONCLU√çDA', 'success');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                
            } catch (error) {
                log('‚ùå Erro na verifica√ß√£o: ' + error.message, 'error');
                console.error(error);
            }
        }

        // Fun√ß√£o para hash (mesma do auth.js)
        async function hashPassword(password) {
            const salt = 'ChampionBot2025_SecureSalt';
            const message = password + salt;
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        // Auto-check ao carregar
        window.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Sistema de diagn√≥stico carregado!', 'success');
            log('', 'info');
            log('üí° GUIA R√ÅPIDO:', 'info');
            log('1Ô∏è‚É£ CONFIGURAR SISTEMA (primeira vez)', 'info');
            log('2Ô∏è‚É£ CRIAR MESTRE R√ÅPIDO', 'info');
            log('3Ô∏è‚É£ TESTAR LOGIN AUTOM√ÅTICO', 'info');
            log('4Ô∏è‚É£ TESTAR ACESSO ADMIN ou IR PARA ADMIN', 'info');
            log('', 'info');
        });
    </script>
</body>
</html>
